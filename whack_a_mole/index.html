<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‘ë”ì§€ ì¡ê¸°</title>
  <style>
    * { margin: 0; padding: 0; }
    main {
      width: 100%;
      height: 100vh;
      height: 100dvh;
      background-color: lightblue;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    main>div {
      background-color: white;
      padding: 2rem;
      border-radius: 1rem;
      position: relative;
    }
    .game-over {
      width: 100%;
      height: 83%;
      position: absolute;
      bottom: 0;
      left: 0;
      background-color: white;
      text-align: center;
      font-size: 2rem;
      display: flex;
      flex-flow: column nowrap;
      justify-content: center;
      align-items: center;
      border-radius: 1rem;
      opacity: 0.8;
    }
    main>div>.hidden {
      display: none;
    }
    #game {
      width: 18rem;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
    }
    .cell {
      position: relative;
      width: 6rem;
      height: 6rem;
      overflow: hidden;
    }
    .gopher, .bomb {
      width: 6rem;
      height: 6rem;
      bottom: 0;
      position: absolute;
      transition: bottom 1s;
    }
    .gopher {
      background: url(./gopher.png) center center no-repeat;
      background-size: 6rem 6rem;
    }
    .dead {
      background: url(./dead_gopher.png) center center no-repeat;
      background-size: 6rem 6rem;
    }
    .bomb {
      background: url(./bomb.png) center center no-repeat;
      background-size: 6rem 6rem;
    }
    .boom {
      background: url(./explode.png) center center no-repeat;
      background-size: 6rem 6rem;
    }
    .cell .hidden {
      bottom: -6rem;
    }
    .hole {
      width: 6rem;
      height: 3rem;
      position: absolute;
      bottom: 0;
      background: url(./mole-hole.png) center center no-repeat;
      background-size: 6rem 3rem;
    }
    .hole-front {
      width: 6rem;
      height: 0.5rem;
      position: absolute;
      bottom: 0;
      background: url(./mole-hole-front.png) center center no-repeat;
      background-size: 6rem 0.5rem;
    }
    #result {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 0.2rem;
    }
    #result>p {
      border: 1px solid lightblue;
      box-sizing: border-box;
      font-size: 1rem;
      line-height: 2rem;
      text-align: center;
    }
    #result>button {
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <main><div>
    <div id="result">
      <p id="timer">60ì´ˆ</p>
      <p id="score">0ì </p>
      <p id="heart">â¤ï¸â¤ï¸â¤ï¸</p>
      <button id="start">ì‹œì‘</button>
    </div>
    <div id="game">
      <div class="cell">
        <div class="hole"></div>
        <div class="gopher hidden"></div>
        <div class="bomb hidden"></div>
        <div class="hole-front"></div>
      </div>
      <div class="cell">
        <div class="hole"></div>
        <div class="gopher hidden"></div>
        <div class="bomb hidden"></div>
        <div class="hole-front"></div>
      </div>
      <div class="cell">
        <div class="hole"></div>
        <div class="gopher hidden"></div>
        <div class="bomb hidden"></div>
        <div class="hole-front"></div>
      </div>
      <div class="cell">
        <div class="hole"></div>
        <div class="gopher hidden"></div>
        <div class="bomb hidden"></div>
        <div class="hole-front"></div>
      </div>
      <div class="cell">
        <div class="hole"></div>
        <div class="gopher hidden"></div>
        <div class="bomb hidden"></div>
        <div class="hole-front"></div>
      </div>
      <div class="cell">
        <div class="hole"></div>
        <div class="gopher hidden"></div>
        <div class="bomb hidden"></div>
        <div class="hole-front"></div>
      </div>
      <div class="cell">
        <div class="hole"></div>
        <div class="gopher hidden"></div>
        <div class="bomb hidden"></div>
        <div class="hole-front"></div>
      </div>
      <div class="cell">
        <div class="hole"></div>
        <div class="gopher hidden"></div>
        <div class="bomb hidden"></div>
        <div class="hole-front"></div>
      </div>
      <div class="cell">
        <div class="hole"></div>
        <div class="gopher hidden"></div>
        <div class="bomb hidden"></div>
        <div class="hole-front"></div>
      </div>
    </div>
    <div class="game-over hidden"><p>GAME OVER</p><p id="scoreline">0ì </p></div>
  </div></main>
  <script>
    const $score = document.querySelector('#score');
    const $timer = document.querySelector('#timer');
    const $start = document.querySelector('#start');
    const $heart = document.querySelector('#heart');
    const $game = document.querySelector('#game');
    const $scoreline = document.querySelector('#scoreline');
    const $gameOver = document.querySelector('.game-over');
    const $$cells = document.querySelectorAll('.cell');

    let started = false;
    let game;

    class Game {
      constructor() {
        this.holes = [];  //ë‘ë”ì§€ ë‚˜ì˜¤ëŠ” êµ¬ë©
        this.score = 0;
        this.heart = 3; //ëª©ìˆ¨ ì„¤ì •
        this.setPlayTime = 60;
        this.playTimer = false; //í”Œë ˆì´íƒ€ì„ ì¹´ìš´íŠ¸í•˜ëŠ” íƒ€ì´ë¨¸
        this.tickId = 0;  //íŠ€ì–´ë‚˜ì˜¤ëŠ” ë°˜ë³µ ì´ë²¤íŠ¸ 
        this.gopherPercent = 0.1; //100ì¤‘ 0~10 ë‚´ ë‚˜ì˜¬ í™•ë¥  10%
        this.bombPercent = 0.12; //100ì¤‘ 10~12 ë‚´ ë‚˜ì˜¬ í™•ë¥  2%
        this.start();
      }

      start() {
        this.holes = Array(9).fill(0);
        this.tickId = setInterval(() => {
          if (this.tick()) { this.tick(); }
        }, 1000); //1ì´ˆì— í•œë²ˆì”© íŠ€ì–´ë‚˜ì˜¤ëŠ” ì´ë²¤íŠ¸
        $timer.textContent = `${this.setPlayTime}ì´ˆ`;
        $score.textContent = `${this.score}ì `;
        this.showHeart();
        this.tick();  //ìµœì´ˆ í•œë²ˆ ì‹¤í–‰ìš©
        this.timer(); //íƒ€ì´ë¨¸ ì‹¤í–‰
        $game.addEventListener('click', this.onClick);
      }

      tick() {  //íŠ€ì–´ë‚˜ì˜¤ëŠ” ì´ë²¤íŠ¸ ì‹¤í–‰
        this.holes.forEach((hole, i) => {
          if (hole) return; //ì´ë¯¸ ì´ë²¤íŠ¸ ë°œìƒì¤‘ì¸ ìƒí™©ì—ì„œ ì¤‘ë³µë°œìƒ ë°©ì§€
          const randomNumber = Math.random();
          if (randomNumber < this.gopherPercent) {
            const $gopher = $$cells[i].querySelector('.gopher');
            this.onTick(i, $gopher);
          } else if (randomNumber < this.bombPercent) {
            const $bomb = $$cells[i].querySelector('.bomb');
            this.onTick(i, $bomb);
          }
        })
      }

      onTick = (i, value) => {
        this.holes[i] = setTimeout(() => {
          value.classList.add('hidden');
          this.holes[i] = 0;  //setTimeout ì•„ì´ë””ê°’ìœ¼ë¡œ ì €ì¥ëœê±° íƒ€ì„ì´ë²¤íŠ¸ ì¢…ë£Œ í›„ ë¹„ì›Œì£¼ê¸°
        }, 1000);
        value.classList.remove('hidden');
      }

      onClick = (e) => {  //ë‘ë”ì§€, í­íƒ„ í´ë¦­ ì´ë²¤íŠ¸ ì§€ì •
        const nodes = [...e.target.parentElement.parentElement.children];
        const index = nodes.indexOf(e.target.parentElement);
        if (e.target.classList.contains('gopher')) {
          this.changeClass(e, index, 'dead');
        }
        if (e.target.classList.contains('bomb')) {
          this.changeClass(e, index, 'boom');
        }
        /*  //removeEventë¥¼ í• ìˆ˜ê°€ ì—†ì–´ì„œ íê¸°
        $$cells.forEach(($cell, i) => {
          $cell.querySelector('.gopher').addEventListener('click', (e) => {
            this.onClick(e, i, 'dead');
          })
          $cell.querySelector('.bomb').addEventListener('click', (e) => {
            this.onClick(e, i, 'boom');
          })
        })
        */
      }

      changeClass = (e, i, value) => {
        this.checkScore(e, value); //ì ìˆ˜ì¦ê°€ or ëª©ìˆ¨ê°ì†Œ
        e.target.classList.add(value);
        e.target.classList.add('hidden');
        clearTimeout(this.holes[i]);  //ì‹¤í–‰ì¤‘ì´ë˜ ëª¨ì…˜ ì¢…ë£Œ
        setTimeout(() => {  //ì£½ê±°ë‚˜ í„°ì§„ê±° ë‚´ë ¤ê°€ë©´ ì´ì „ ì´ë¯¸ì§€ë¡œ ì´ˆê¸°í™”
          e.target.classList.remove(value);
          this.holes[i] = 0;
        }, 1000);
      }

      checkScore = (e, value) => {
        if (value === 'dead' && !e.target.classList.contains('dead')) { //ì ìˆ˜ ì¶œë ¥
          this.score++;
          $score.textContent = `${this.score}ì `;
        } else if (value === 'boom' && !e.target.classList.contains('boom')) { //ì ìˆ˜ ì¶œë ¥
          this.heart--;
          this.showHeart();
        }
        if (this.heart < 1) { //ë‚¨ì€ ëª©ìˆ¨ ì—†ìœ¼ë©´ ê²Œì„ ì˜¤ë²„
          $heart.textContent = 'ğŸ˜µ';
          quit();
        }
      }
      
      timer() {
        this.playTimer = setInterval(() => {
          this.setPlayTime--;
          $timer.textContent = `${this.setPlayTime}ì´ˆ`;
          if (this.setPlayTime < 1) {
            quit();
          }
        }, 1000);
      }

      showHeart() { //ì”ì—¬ ëª©ìˆ¨ ì¶œë ¥
        $heart.textContent = '';
        for(let i = 0 ; i < this.heart ; i++) {
          $heart.textContent += 'â¤ï¸';
        }
      }
    }

    const quit = (e) => {
      $scoreline.textContent = `${game.score}ì `;
      $gameOver.classList.remove('hidden');
      $game.removeEventListener('click', game.onClick);
      clearInterval(game.tickId);
      clearInterval(game.playTimer);
      started = false;
      game = null;
    }

    const startGame = (e) => {
      $gameOver.classList.add('hidden');
      if (started) return;
      started = true;
      game = new Game();
    }

    $start.addEventListener('click', startGame);
  </script>
</body>
</html>
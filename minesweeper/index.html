<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì§€ë¢°ì°¾ê¸°</title>
  <style>
    * { margin: 0; padding: 0; }
    main {
      width: 100%;
      height: 100vh;
      height: 100dvh;
      background-color: lightblue;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    section {
      width: auto;
      height: auto;
      padding: 2rem;
      background-color: white;
      border-radius: 1rem;
    }
    #select-screen {
      display: block;
    }
    #select-form {
      display: flex;
      gap: 0.5rem;
    }
    #select-form select, #select-form button {
      font-size: 1.5rem;
      padding: 0.5rem;
      line-height: 2rem;
      height: 3rem;
      box-sizing: border-box;
    }
    #game-screen {
      display: none;
    }
    #result {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-gap: 0.3rem;
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    #reset {
      justify-self: center;
      font-size: 1.8rem;
      padding: 0 0.3rem;
    }
    #mine {
      justify-self: start;
      padding: 0.5rem;
      border: 1px solid lightblue;
      text-align: right;
    }
    #time {
      flex: 1;
      justify-self: end;
      padding: 0.5rem;
      border: 1px solid lightblue;
      text-align: right;
    }
    table {
      border-collapse: collapse;
    }
    td {
      border: 1px solid white;
      text-align: center;
      line-height: 1.1rem;
      width: 1.1rem;
      height: 1.1rem;
      background-color: lightblue;
    }
    td.opened {
      border: 1px solid lightblue;
      background-color:white;
    }
    td.flag {
      background-color: red;
    }
    td.question {
      background-color: orange;
    }
  </style>
</head>
<body>
  <main>
    <section id="select-screen">
      <form id="select-form">
        <select name="select-box">
          <option value="9">ì´ˆê¸‰ (9 * 9)</option>
          <option value="16">ì¤‘ê¸‰ (16 * 16)</option>
          <option value="30">ê³ ê¸‰ (30 * 30)</option>
        </select>
        <button>ì‹œì‘</button>
      </form>
    </section>
    <section id="game-screen">
      <div id="result">
        <div id="mine"></div>
        <button id="reset">ğŸ¥º</button>
        <div id="time"></div>
      </div>
      <table id="table">
        <tbody></tbody>
      </table>
    </section>
  </main>
  <script>
    const $selectScreen = document.querySelector('#select-screen');
    const $selectForm = document.querySelector('#select-form');
    const $gameScreen = document.querySelector('#game-screen');
    const $tbody = document.querySelector('#table tbody');
    const $result = document.querySelector('#result');
    const $mine = document.querySelector('#mine');
    const $time = document.querySelector('#time');
    const $reset = document.querySelector('#reset');
    let box = [];
    let game = null;
    let clickable = false;
    let time = 0;
    let timer;

    const CODE = {
      OPENED : 0,
      DEFAULT : -1,
      QUESTION : -2,
      FLAG : -3,
      FLAG_MINE : -4,
      QUESTION_MINE : -5,
      MINE : -6,
    }

    class Game {
      constructor(size) { //ì‹ ê·œ ê²Œì„
        this.size = Number(size) * Number(size);
        this.lineSize = Number(size);
        this.mine = Math.round(Number(size) * Number(size) / 5 - 4);
        this.boxList = [];
        this.openCount = 0;
        this.start();
      }

      start() { //ê²Œì„ ì‹œì‘
        this.changeScreen('game');
        this.createGame();
        timer = setInterval(()=>{
          time++;
          $time.textContent = time;
        }, 100)
        $mine.textContent = this.mine;
      }

      countMine = (trId, tdId) => { //ì£¼ë³€ì— ì§€ë¢° ìˆëŠ”ì§€ ì²´í¬
        const mines = [ CODE.MINE, CODE.FLAG_MINE, CODE.QUESTION_MINE ];
        let i = 0;
        mines.includes(this.boxList[trId - 1]?.[tdId - 1]) && i++;  //optional chainingì„ ë°°ì› ë‹¤
        mines.includes(this.boxList[trId - 1]?.[tdId]) && i++;
        mines.includes(this.boxList[trId - 1]?.[tdId + 1]) && i++;
        mines.includes(this.boxList[trId][tdId - 1]) && i++;
        mines.includes(this.boxList[trId][tdId + 1]) && i++;
        mines.includes(this.boxList[trId + 1]?.[tdId - 1]) && i++;
        mines.includes(this.boxList[trId + 1]?.[tdId]) && i++;
        mines.includes(this.boxList[trId + 1]?.[tdId + 1]) && i++;
        return i;
      }

      open = (trId, tdId) => {  //ë°•ìŠ¤ ì˜¤í”ˆ ì²˜ë¦¬
        if (this.boxList[trId]?.[tdId] >= CODE.OPENED) {  //ì¬ê·€ ìµœì í™” (ì—´ì—ˆë˜ ì¹¸ ì•ˆì—´ë¦¬ê²Œ)
          return;
        }
        const target = $tbody.children[trId]?.children[tdId];
        if (!target) {
          return;
        }
        const count = this.countMine(trId, tdId); //ì§€ë¢° ê°¯ìˆ˜ í™•ì¸
        target.textContent = count || ''; //ì¡°ê±´ì´ ||ê°€ ì•„ë‹ˆê³  ??ì´ë©´ Nullê³¼ undefindë§Œ falseë¡œ ì¸ì • nullish coalescing
        target.className = 'opened';
        this.boxList[trId][tdId] = count;
        this.openCount++;
        if (this.size - this.openCount === this.mine) {
          clearInterval(timer);
          $reset.textContent = 'ğŸ¥³';
          clickable = false;
          return;
        }
        return count;
      }

      openBox(trId, tdId) { //ë°•ìŠ¤ ì—´ì–´ë³´ê¸°
        const count = this.open(trId, tdId);
        if (count === 0) {  //ë‚´ ë°•ìŠ¤ ì£¼ë³€ 8ì¹¸ì— ì§€ë¢°ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´
          this.openBox(trId - 1, tdId - 1);
          this.openBox(trId - 1, tdId);
          this.openBox(trId - 1, tdId + 1);
          this.openBox(trId, tdId - 1);
          this.openBox(trId, tdId + 1);
          this.openBox(trId + 1, tdId - 1);
          this.openBox(trId + 1, tdId);
          this.openBox(trId + 1, tdId + 1);
        }
      }

      onLeftClick(e) {
        if (!clickable) {  //í´ë¦­ ë°©ì§€
          return;
        }
        const trId = e.target.parentNode.rowIndex;
        const tdId = e.target.cellIndex
        let thisData = game.boxList[trId][tdId];  //Dataì—ì„œ í˜„ì¬ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
        if (thisData === CODE.MINE) {  //ì§€ë¢°ë¼ë©´
          for(let i = 0 ; i < game.boxList.length ; i++){
            for(let j = 0 ; j < game.boxList[i].length ; j++){
              if (game.boxList[i][j] <= CODE.FLAG_MINE){
                $tbody.children[i].children[j].textContent = 'ğŸ’£'; //ì§€ë¢°í‘œì‹œ
              }
            }
          }
          $reset.textContent = 'ğŸ˜µ';
          clearInterval(timer);
          clickable = false;
          return;
        }
        if (thisData === CODE.DEFAULT) {//ì§€ë¢°ê°€ ì•„ë‹ˆë¼ë©´
          game.openBox(trId, tdId);
        }
      }

      changeBox = (e, trId, tdId) => { //ì²´í¬ ì¡°ê±´
        const target = $tbody.children[trId]?.children[tdId];
        let thisData = this.boxList[trId][tdId];  //Dataì—ì„œ í˜„ì¬ê°’ ë¶ˆëŸ¬ì˜¤ê¸°

        if (thisData === CODE.DEFAULT) {  //ì§€ë¢°ì—†ëŠ” ì¼ë°˜ì¹¸ì¼ë•Œ
          target.className = 'flag';
          target.textContent = '!';
          this.boxList[trId][tdId] = CODE.FLAG;
          $mine.textContent--;
        } else if (thisData === CODE.FLAG) { //ì§€ë¢°ì—†ëŠ” ê¹ƒë°œì¹¸ì¼ë•Œ
          $mine.textContent++;
          target.className = 'question';
          target.textContent = '?';
          this.boxList[trId][tdId] = CODE.QUESTION;
        } else if (thisData === CODE.QUESTION) { //ì§€ë¢°ì—†ëŠ” ë¬¼ìŒí‘œì¹¸ì¼ë•Œ
          target.className = '';
          target.textContent = '';
          this.boxList[trId][tdId] = CODE.DEFAULT;
        } else if (thisData === CODE.MINE) { //ì§€ë¢°ìˆëŠ” ì¼ë°˜ì¹¸ì¼ë•Œ
          target.className = 'flag';
          target.textContent = '!';
          this.boxList[trId][tdId] = CODE.FLAG_MINE;
          $mine.textContent--;
        } else if (thisData === CODE.FLAG_MINE) { //ì§€ë¢°ìˆëŠ” ê¹ƒë°œì¹¸ì¼ë•Œ
          $mine.textContent++;
          target.className = 'question';
          target.textContent = '?';
          this.boxList[trId][tdId] = CODE.QUESTION_MINE;
        } else if (thisData === CODE.QUESTION_MINE) { //ì§€ë¢°ìˆëŠ” ë¬¼ìŒí‘œì¹¸ì¼ë•Œ
          target.className = '';
          target.textContent = '';
          this.boxList[trId][tdId] = CODE.MINE;
        }
      }
      
      onRightClick(e) {
        e.preventDefault();
        const trId = e.target.parentNode.rowIndex;  //ì„ íƒí•œ ì¤„ ìœ„ì¹˜
        const tdId = e.target.cellIndex;  //ì„ íƒí•œ ì¹¸ ìœ„ì¹˜
        const thisData = game.boxList[trId][tdId];  //Dataì—ì„œ í˜„ì¬ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
        if (!clickable || thisData > CODE.DEFAULT) {  //ì˜¤í”ˆëœì¹¸ ìš°í´ë¦­ ë°©ì§€
          return;
        }
        game.changeBox(e, trId, tdId);
      }

      createTable() {
        /* í…Œì´ë¸” ê·¸ë¦¬ê¸° */
        for (let i = 0 ; i < this.lineSize ; i++) { //í•œì¤„ ì‚¬ì´ì¦ˆë§Œí¼ trë§Œë“¤ê¸°
          const $tr = document.createElement('tr');
          for (let j = 0 ; j < this.lineSize ; j++) { //í•œì¤„ ì‚¬ì´ì¦ˆë§Œí¼ tdë§Œë“¤ê¸°
            const $td = document.createElement('td');
            $tr.append($td);
          }
          $tbody.append($tr);
          $tbody.addEventListener('click', this.onLeftClick);
          $tbody.addEventListener('contextmenu', this.onRightClick);
        }
      }

      createGame() { //ìƒˆ ê²Œì„ ì¶œë ¥
        const cellList = new Array(this.size).fill(-1); //ì‹œì‘í•œ ê²Œì„ ê°¯ìˆ˜ë§Œí¼ ë°°ì—´ ì €ì¥
        for (let i = 0 ; i < this.mine ; i++) { //ì§€ë¢° ê°¯ìˆ˜ë§Œí¼ ëœë¤ ê°’ ë½‘ì•„ì„œ ì¸ë±ìŠ¤ë¡œ ì‚¬ìš©
          const randomIndex = Math.floor(Math.random() * cellList.length);
          if (cellList[randomIndex] === -6) {  //ì´ë¯¸ ê°’ ìˆìœ¼ë©´ ë„˜ì–´ê°
            i--;
          } else {  //ê°’ ì—†ëŠ” ìœ„ì¹˜ì— ê°’ ì¶”ê°€
            cellList[randomIndex] = -6;
          }
        }
        let cellListCopy;//í•œì¤„ ê¸¸ì´ë§Œí¼ë§Œ ì˜ë¼ì„œ 2ì°¨ ë°°ì—´ë¡œ ë³´ê´€
        for (let i = 0 ; i < this.lineSize ; i++) {
          cellListCopy = cellList.slice(i * this.lineSize, (i + 1) * this.lineSize);
          this.boxList.push(cellListCopy);
        }
        this.createTable(this);
        console.log(this.boxList);
      }

      changeScreen(screen) {  //í™”ë©´ ì „í™˜
        if (screen === 'game') {
          $selectScreen.style.display = 'none';
          $gameScreen.style.display = 'block';
          clickable = true;
        } else if (screen === 'select') {
          $selectScreen.style.display = 'block';
          $gameScreen.style.display = 'none';
        }
      }
    }

    const onGame = (e) => { //ë‚œì´ë„ ì„ íƒ í›„ ì´ë²¤íŠ¸
      e.preventDefault();
      size = e.target['select-box'].value;
      game = new Game(size);
    }
    const quit = () => {
      game.changeScreen('select');
      clickable = false;
      size = null;
      game = null;
      time = 0;
      $tbody.innerHTML = '';
      $reset.textContent = 'ğŸ¥º';
      $time.textContent = '';
      $mine.textContent = '';
    }

    $selectForm.addEventListener('submit', onGame);
    $reset.addEventListener('click', quit);
  </script>
</body>
</html>